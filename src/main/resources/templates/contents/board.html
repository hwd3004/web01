<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{common/layout}">

<style>
.text-overflow {
	overflow: hidden;
	text-overflow: ellipsis;
	white-space: nowrap;
}
</style>

<section layout:fragment="content">
	<h1>계층형 게시판</h1>
	<div class="container">
		<div id="post__list"></div>
	</div>
	<div class="modal fade" id="savePostsModal" tabindex="-1" role="dialog"
		aria-labelledby="savePostsLabel" aria-hidden="true">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="savePostsLabel">게시글 등록</h5>
					<button type="button" class="close" data-dismiss="modal" aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<form enctype="multipart/form-data" th:action="@{/post/save}" method="post" id="write-frm">
						<div class="form-group">
							<label for="title">제목</label> <input type="text" class="form-control" name="title" id="title"
								placeholder="제목을 입력하세요" />
						</div>
						<div class="form-group">
							<label for="author"> 이미지 </label> <input type="file" class="form-control" name="images"
								id="images" placeholder="이미지 첨부" multiple accept="image/*" />
						</div>
						<div class="form-group">
							<label for="content"> 내용 </label>
							<textarea class="form-control" name="content" id="content" placeholder="내용을 입력하세요"
								style="resize: none; height: 300px;"></textarea>
						</div>
					</form>
					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" data-dismiss="modal">
							취소</button>
						<button type="button" class="btn btn-primary" id="btn-write">등록</button>
					</div>
				</div>
			</div>
		</div>
	</div>
	<script>
		let board = {
			init : function() {
				this.getPosts();
				this.clickPost();
				this.clickPageNation();
			},
			csrf : {
				token : $("meta[name='_csrf']").attr("content"),
				header : $("meta[name='_csrf_header']").attr("content"),
			},
			getPosts : function(pageNumber) {
				let $this = this;
				let page = pageNumber ? pageNumber : 1;
				$.ajax(
						{
							type : "GET",
							url : `/posts?page=${page}`,
							dataType : "html",
							contentType : "application/json; charset=utf-8",
							beforeSend : function(xhr) {
								xhr.setRequestHeader($this.csrf.header,
										$this.csrf.token);
							},
						}).done(function(result) {
					$("#post__list").html(result);
				}).fail(function(error) {
					console.log(error);
				});
			},
			clickPost : function() {
				$("#post__list").on(
						"click",
						"#wrap__post td",
						function() {
							const postId = $(this).parent().children(":first")
									.data("id");
							if (postId === "del") {
								alert("삭제된 게시글 입니다.");
							} else {
								location.href = `/post/${postId}`;
							}
						});
			},
			clickPageNation : function() {
				$("#post__list").on("click", ".pagination li", function() {
					const pageValue = $(this).text();

					if ($(this).data("haspage") === "none") {
						return;
					}

					if (pageValue === "Previous") {
						const page = $(".pagination .active > a").text();
						board.getPosts(Number(page) - 1);
					} else if (pageValue === "Next") {
						const page = $(".pagination .active > a").text();
						console.log("다음 클릭", Number(page) + 1);
						board.getPosts(Number(page) + 1);
					} else {
						console.log("page 넘버 클릭", pageValue);
						board.getPosts(pageValue);
					}
				});
			},
		};
		$(function() {
			board.init();
		});
	</script>
</section>
</html>